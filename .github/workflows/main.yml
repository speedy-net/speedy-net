name: GitHub Actions Speedy Net
on:
  - 'push'
jobs:
  tests:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os:
          - 'ubuntu-20.04'
          - 'ubuntu-22.04'
          - 'ubuntu-latest'
        python-version:
          - '3.8'
          - '3.9'
          - '3.10'
        postgresql-version:
          - '13'
          - '14'
          - '15'
          - 'latest'
        is-master-or-staging:
          - ${{ github.ref == 'refs/heads/master' || github.ref == 'refs/heads/staging' }}
        exclude:
          - os: 'ubuntu-20.04'
            postgresql-version: 'latest'
          - os: 'ubuntu-20.04'
            postgresql-version: '14'
          - os: 'ubuntu-20.04'
            postgresql-version: '15'
          - os: 'ubuntu-22.04'
            postgresql-version: 'latest'
          - os: 'ubuntu-22.04'
            postgresql-version: '13'
          - os: 'ubuntu-latest'
            postgresql-version: '13'
          - os: 'ubuntu-latest'
            postgresql-version: '14'
          - os: 'ubuntu-latest'
            postgresql-version: '15'
          - os: 'ubuntu-latest'
            is-master-or-staging: false
    services:
      postgres:
        image: postgres:${{ matrix.postgresql-version }}
        env:
          POSTGRES_HOST_AUTH_METHOD: trust
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    steps:
      - name: Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v2
        with:
          python-version: ${{ matrix.python-version }}
      - run: echo "🎉 The job was automatically triggered by a ${{ github.event_name }} event."
      - run: echo "🐧 This job is now running on a ${{ runner.os }} server hosted by GitHub!"
      - run: echo "🔎 The name of your branch is ${{ github.ref }} and your repository is ${{ github.repository }}."
      - name: Check out repository code
        uses: actions/checkout@v2
      - run: echo "💡 The ${{ github.repository }} repository has been cloned to the runner."
      - run: echo "🖥️ The workflow is now ready to test your code on the runner."
      - name: List files in the repository
        run: |
          ls ${{ github.workspace }}
      - run: cp env.ini.tests env.ini
      - run: pip install --upgrade -r requirements.txt -r tests-requirements.txt
      - run: pip freeze
      - run: pwd
      - run: lsb_release -a
      - run: psql --version
      - run: psql -h 127.0.0.1 -U postgres -c 'select version();'
      - run: psql -h 127.0.0.1 -U postgres -c 'create user pguser;'
      - run: psql -h 127.0.0.1 -U postgres -c 'alter user pguser createdb;'
      - run: python --version
      - run: ./run_all_tests_with_all_warnings.sh
      - run: echo "🍏 This job's status is ${{ job.status }}."
